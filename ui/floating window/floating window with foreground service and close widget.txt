first create a foreground service, check in on foreground service tutorial and modify the code

//RunningService.kt
class RunningService : Service() {

    private var LAYOUT_FLAG: Int? = null
    private lateinit var mFloatingView: View
    private lateinit var windowManager: WindowManager
    private lateinit var imageClose: ImageView
	...
	private fun startFloatingWindow() {
        //setup proper flag for different android versions
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            LAYOUT_FLAG = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
        } else {
            LAYOUT_FLAG = WindowManager.LayoutParams.TYPE_PHONE
        }

        //inflate
        mFloatingView = LayoutInflater.from(this).inflate(R.layout.floating_layout, null)
        val layoutParams = WindowManager.LayoutParams(
            WindowManager.LayoutParams.WRAP_CONTENT,
            WindowManager.LayoutParams.WRAP_CONTENT,
            LAYOUT_FLAG!!,
            WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
            PixelFormat.TRANSLUCENT
        )

        //initial position
        layoutParams.gravity = Gravity.TOP or Gravity.RIGHT
        layoutParams.x = 0
        layoutParams.y = 100

        //create a close component
        val imageParams = WindowManager.LayoutParams(
            140,
            140,
            LAYOUT_FLAG!!,
            WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
            PixelFormat.TRANSLUCENT
        )
        imageParams.gravity = Gravity.BOTTOM or Gravity.CENTER
        imageParams.y = 100

        windowManager = getSystemService(WINDOW_SERVICE) as WindowManager
        imageClose = ImageView(this)
        imageClose.setImageResource(R.drawable.ic_launcher_foreground)
        imageClose.visibility = View.INVISIBLE
        windowManager.addView(imageClose, imageParams)
        windowManager.addView(mFloatingView, layoutParams)
        mFloatingView.visibility = View.VISIBLE

        val height = windowManager.defaultDisplay.height
        val width = windowManager.defaultDisplay.width

        val tvWidget = mFloatingView.findViewById<TextView>(R.id.tvWidget)

        tvWidget.text = "running"

        tvWidget.setOnTouchListener(
            object : View.OnTouchListener {
                var initialX = 0
                var initialY = 0
                var initialTouchX:Float = 0.0f
                var initialTouchY:Float = 0.0f
                override fun onTouch(v: View, event: MotionEvent): Boolean {
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            imageClose.visibility = View.VISIBLE
                            initialX = layoutParams.x
                            initialY = layoutParams.y

                            //touch position
                            initialTouchX = event.getRawX()
                            initialTouchY = event.getRawY()

                            return true
                        }

                        MotionEvent.ACTION_UP -> {
                            imageClose.visibility = View.GONE
                            layoutParams.x = initialX+(initialTouchX-event.getRawX()).toInt()
                            layoutParams.y = initialY+(event.getRawY() - initialTouchY).toInt()
                            //remove widget
                            if(layoutParams.y>(height*0.6)){
                                stopSelf()
                            }
                            return true
                        }

                        MotionEvent.ACTION_MOVE -> {
                            //calculate x and y coordinates
                            layoutParams.x = initialX+(initialTouchX-event.getRawX()).toInt()
                            layoutParams.y = initialY+(event.getRawY()-initialTouchY).toInt()

                            //update layout with view coordinates
                            windowManager.updateViewLayout(mFloatingView, layoutParams)
                            if(layoutParams.y>(height*0.6)){
                                imageClose.setImageResource(R.drawable.ic_launcher_background)
                            }else{
                                imageClose.setImageResource(R.drawable.ic_launcher_foreground)
                            }
                            return true
                        }
                    }
                    return false
                }
            })
    }
	...
	private fun start() {
		...
        startForeground(1, notification)
        startFloatingWindow()
        isServiceRunning = true;
    }
	
	override fun onDestroy() {
        super.onDestroy()
        if(mFloatingView!=null){
            windowManager.removeView(mFloatingView)
        }
        if(imageClose!=null){
            windowManager.removeView(imageClose)
        }
        ...
    }
	
//floating_layout.xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <RelativeLayout
        android:id="@+id/layout_widget"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_centerHorizontal="true"
        android:layout_margin="30dp"
        >
        <TextView
            android:id="@+id/tvWidget"
            android:layout_width="120dp"
            android:layout_height="120dp"
            android:textSize="22dp"
            android:text="10"
            android:textStyle="bold"
            android:gravity="center"
            android:textColor="@color/white"
            android:background="@color/black"/>
    </RelativeLayout>

</RelativeLayout>

//MainActivity.kt
class MainActivity : AppCompatActivity() {
	...
    override fun onCreate(savedInstanceState: Bundle?) {
		...
        binding.openFloatingButton.setOnClickListener{
            startFloatingWindowService()
        }
    }
	...
	private fun startFloatingWindowService(){
        if(!Settings.canDrawOverlays(this@MainActivity)){
            getFloatingWindowPermission()
        }else{
            Log.i("myTag", "starting")
            //create an intent, convert enum to string because it is an enum
            Intent(applicationContext, RunningService::class.java).also{
                it.action = RunningService.Actions.START.toString()//call the action inside the RunningService
                startService(it)//start the service
                finish()
            }
        }
    }
	...
	private fun getFloatingWindowPermission(){
        //for the floating window
        if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.M){
            val intent = Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse("package:$packageName"))
            startActivityForResult(intent, 1)
        }
    }
	
	override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if(requestCode==1)
        {
            if(!Settings.canDrawOverlays(this@MainActivity)){
                Toast.makeText(this, "Permission denied by user", Toast.LENGTH_LONG).show()
            }
        }
    }
	...
}

//AndroidManifest.xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
	...
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
	...
	</activity>
        <service
            android:name=".background_service.RunningService"
            android:foregroundServiceType="connectedDevice"
            android:enabled="true"
            />
    </application>
</manifest>

//To create a tap function just add isMoved variable
tvWidget.setOnTouchListener(
            object : View.OnTouchListener {
                ...
                var isMoved = false 
				...
				MotionEvent.ACTION_UP -> {
                            imageClose.visibility = View.GONE
                            layoutParams.x = initialX+(initialTouchX-event.getRawX()).toInt()
                            layoutParams.y = initialY+(event.getRawY() - initialTouchY).toInt()

                            //touch event
                            if(!isMoved){
                                Log.i("myTag", "tapped")
								...
							}
							isMoved = false							
				}
				
				MotionEvent.ACTION_MOVE -> {
							...
                            isMoved = true
                            return true
                        }
				
				